{% extends "base.html" %}
{% load static %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<div class="container-fluid">
    <h3 class="mb-3">{{ title }}</h3>
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    <div class="mb-3">
        <button id="fetchDataBtn" type="button" class="btn btn-primary">Fetch TakeALot Data</button>
        <span id="loading" class="ms-3" style="display: none;">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Loading, please wait...
        </span>
    </div>
    <div id="tableContainer"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap 5 JS bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script>
    function sanitizeId(value) {
        return value.replace(/[^a-zA-Z0-9_-]/g, "_");
    }

    // Simple sort function for table rows (using text comparison)
    function sortTable(table, column, asc = true) {
        const tbody = table.tBodies[0];
        Array.from(tbody.querySelectorAll("tr.main-row"))
            .sort((a, b) => {
                // Since the first column is used for the expand button, adjust index by +1
                const aText = a.querySelectorAll("td")[column + 1].innerText.trim();
                const bText = b.querySelectorAll("td")[column + 1].innerText.trim();
                const aVal = parseFloat(aText) || aText;
                const bVal = parseFloat(bText) || bText;
                return asc ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
            })
            .forEach(tr => {
                tbody.appendChild(tr);
                // Append the details row immediately following the main row if it exists
                let detailsRow = document.getElementById("details-" + sanitizeId($(tr).data("sku")));
                if (detailsRow) {
                    tbody.appendChild(detailsRow);
                }
            });
    }

    // Function to make table columns resizable
    function makeResizable(table) {
        const thElems = table.querySelectorAll('th');
        thElems.forEach(function(th) {
            // Create a resizer element
            const resizer = document.createElement('div');
            resizer.style.width = '5px';
            resizer.style.height = '100%';
            resizer.style.position = 'absolute';
            resizer.style.top = '0';
            resizer.style.right = '0';
            resizer.style.cursor = 'col-resize';
            resizer.style.userSelect = 'none';
            th.style.position = 'relative';
            th.appendChild(resizer);
            
            let startX, startWidth;
            resizer.addEventListener('mousedown', function(e) {
                startX = e.pageX;
                startWidth = th.offsetWidth;
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
            });
            
            function mouseMoveHandler(e) {
                let newWidth = startWidth + (e.pageX - startX);
                th.style.width = newWidth + 'px';
            }
            
            function mouseUpHandler(e) {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
            }
        });
    }

    $(document).ready(function() {
        $("#fetchDataBtn").on("click", function() {
            // Disable button and show loading indicator
            $(this).prop("disabled", true);
            $("#loading").show();

            $.ajax({
                url: "{% url 'plugin:takealotintegrator:fetch-takealot-data' %}",
                method: "GET",
                success: function(response) {
                    $("#loading").hide();
                    const data = response.data;
                    const sanitizeId = value => value.replace(/[^a-zA-Z0-9_-]/g, "_");
                    let tableHtml = `
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="dataTable" class="table table-striped table-bordered table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-center"></th>
                                            <th class="text-center">Image</th>
                                            <th class="text-center">SKU</th>
                                            <th class="text-center">Product Name</th>
                                            <th class="text-center">SDC Total</th>
                                            <th class="text-center">Sales Count</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    data.forEach(item => {
                        const sanitizedSku = sanitizeId(item.sku);
                        const hasWarehouses = item.warehouses && item.warehouses.length > 0;
                        tableHtml += `<tr class="main-row" data-sku="${sanitizedSku}">`
                                    + `<td class="text-center">`;
                        if (hasWarehouses) {
                            tableHtml += `<button class="btn btn-sm btn-outline-secondary toggle-details" data-bs-target="#details-${sanitizedSku}" aria-expanded="false" aria-controls="details-${sanitizedSku}">
                                            <i class="bi bi-plus"></i>
                                          </button>`;
                        }
                        tableHtml += `</td>`;
                        // New cell for product image
                        tableHtml += `<td class="text-center">`;
                        if (item.product_image) {
                            tableHtml += `<img src="${item.product_image}" alt="Product Image" style="max-width:40px; max-height:40px;">`;
                        } else {
                            tableHtml += `-`;
                        }
                        tableHtml += `</td>`;
                        
                        tableHtml += `<td>${sanitizedSku}</td>
                                      <td>${item.product_name}</td>
                                      <td>${item.sdc_total}</td>
                                      <td>${item.sales_count}</td>
                                  </tr>`;
                        if (hasWarehouses) {
                            tableHtml += `<tr class="collapse" id="details-${sanitizedSku}">
                                            <td colspan="6">
                                                <ul class="list-group list-group-flush">`;
                            item.warehouses.forEach(w => {
                                tableHtml += `<li class="list-group-item">${w.warehouse_name} (SDC: ${w.sdc})</li>`;
                            });
                            tableHtml += `       </ul>
                                            </td>
                                          </tr>`;
                        }
                    });
                    tableHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
                    $("#tableContainer").html(tableHtml);

                    $(".toggle-details").on("click", function() {
                        const targetSelector = $(this).data("bs-target");
                        const icon = $(this).find("i");
                        const target = $(targetSelector);
                        const isShown = target.hasClass("show");

                        // Manually toggle
                        if (isShown) {
                            target.removeClass("show");
                            icon.removeClass("bi-dash").addClass("bi-plus");
                        } else {
                            $(".collapse.show").removeClass("show"); // Close any open panels
                            $(".toggle-details i").removeClass("bi-dash").addClass("bi-plus"); // Reset all icons

                            target.addClass("show");
                            icon.removeClass("bi-plus").addClass("bi-dash");
                        }
                    });

                    // Add click handlers to table headers for sorting (skip the first two columns)
                    $("#dataTable th").each(function(index) {
                        if (index === 0 || index === 1) return; // skip the expand and image column headers
                        $(this).css("cursor", "pointer").data("asc", true);
                        $(this).on("click", function() {
                            const asc = $(this).data("asc");
                            // Adjust the column index by subtracting 2
                            sortTable(document.getElementById("dataTable"), index - 2, asc);
                            $(this).data("asc", !asc);
                        });
                    });

                    // Make columns resizable
                    makeResizable(document.getElementById('dataTable'));
                },
                error: function(error) {
                    $("#loading").hide();
                    alert("Error fetching data.");
                    console.error("Error fetching data:", error);
                    $("#fetchDataBtn").prop("disabled", false);
                }
            });
        });
    });
</script>
{% endblock %}